name: JHipster CI/CD

on:
  push:
    branches: ["deploy_gasdev"]
  pull_request:
    branches: ["deploy_gasdev"]

jobs:
  # ======================================================================================
  # 1. Lint (Nettoyage de code et vÃ©rification de style)
  #    -> Ã€ complÃ©ter avec vos commandes de linting spÃ©cifiques (ex: npm run lint, checkstyle)
  # ======================================================================================
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Dummy Lint Step
        run: echo "Linting step placeholder: Replace with actual linting commands."
    # Si cette Ã©tape est critique, ajoutez 'fail-fast: true' ou configurez-la correctement.

  # --------------------------------------------------------------------------------------

  # ======================================================================================
  # 2. Build (Construction de l'application et crÃ©ation du JAR)
  # ======================================================================================
  build:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Build with Maven
        run: ./mvnw -ntp verify -Pprod -DskipTests
      
      - name: Upload application artifact (JAR)
        uses: actions/upload-artifact@v4
        with:
          name: jhipster-app
          path: target/*.jar
          retention-days: 7

  # --------------------------------------------------------------------------------------

  # ======================================================================================
  # 3. Test (Unitaires et E2E)
  #    (Les tests E2E devraient idÃ©alement dÃ©pendre de la BDD et du backend dÃ©marrÃ©)
  # ======================================================================================
  test-unit:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Dummy Unit Test Step
        run: echo "Unit testing step placeholder: Replace with actual unit tests."

  test-e2e:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Dummy E2E Test Step
        run: echo "E2E testing step placeholder: Replace with actual E2E tests."

  # --------------------------------------------------------------------------------------

  # ======================================================================================
  # 4. Deploy (Transfert SCP et DÃ©marrage Systemd) - CORRIGÃ‰
  # ======================================================================================
  deploy-vps:
    needs: build # DÃ©pend de la rÃ©ussite de la construction
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. TÃ©lÃ©charger l'artefact (le JAR)
      - name: Download application artifact (JAR)
        uses: actions/download-artifact@v4
        with:
          name: jhipster-app
          path: target/

      # 1.5. VÃ©rifier et installer les outils nÃ©cessaires sur le VPS (JDK pour l'outil 'jar')
      - name: Prerequisites Check and JDK Install
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: bababooeys.gasdev.fr
          username: root
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: 2222
          script: |
            echo "VÃ©rification et installation des dÃ©pendances (JDK pour 'jar' et 'file')."
            apt update
            
            # Installation du JDK par dÃ©faut (fournit l'outil 'jar') et de l'outil 'file'.
            apt install -y default-jdk file || echo "ATTENTION: L'installation du JDK par dÃ©faut a Ã©chouÃ©. Poursuite, mais le diagnostic pourrait ne pas fonctionner."

      # 2. RÃ©cupÃ©rer le nom du JAR
      - name: Get JAR file name
        id: get_jar
        run: echo "JAR_NAME=$(ls target/*.jar | xargs basename)" >> $GITHUB_OUTPUT

      # 2.5. CHARGER LA CLÃ‰ PRIVÃ‰E DANS L'AGENT SSH
      - name: Start SSH Agent and Add Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          
      # 3. TRANSFERT SÃ‰CURISÃ‰ AVEC SCP MANUEL (Via SSH Agent)
      - name: Transfer JAR via SCP Command (Bypass corruption issue)
        env:
          JAR_FILE: target/${{ steps.get_jar.outputs.JAR_NAME }}
          TARGET_HOST: bababooeys.gasdev.fr
          TARGET_PORT: 2222
          TARGET_PATH: /opt/jhipster-app/app.jar
        run: |
          # DÃ‰SACTIVATION DE LA VÃ‰RIFICATION DES CLÃ‰S D'HÃ”TE (-o StrictHostKeyChecking=no)
          SSH_OPTS="-o StrictHostKeyChecking=no"

          # 1. CrÃ©ation du rÃ©pertoire distant via SSH
          ssh $SSH_OPTS -p $TARGET_PORT root@$TARGET_HOST "mkdir -p /opt/jhipster-app"
          
          # 2. Transfert binaire du JAR (Correction Port: -P majuscule pour scp)
          scp $SSH_OPTS -P $TARGET_PORT $JAR_FILE root@$TARGET_HOST:$TARGET_PATH
          
      # 4. DIAGNOSTIC ET DÃ‰PLOIEMENT via SSH (Gestion Systemd)
      - name: Deploy and Start via SSH (Systemd)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: bababooeys.gasdev.fr
          username: root
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: 2222
          script: |
            # VARIABLES
            SERVICE_NAME="jhipster-app"
            STATIC_JAR_NAME="app.jar" 
            DEPLOY_PATH="/opt/jhipster-app"
            JAR_FULL_PATH="$DEPLOY_PATH/$STATIC_JAR_NAME"
            
            echo "--- DÃ©marrage du diagnostic du JAR ---"
            
            # Diagnostic 1: VÃ©rification de la taille et du type du fichier
            ls -lh $JAR_FULL_PATH
            file $JAR_FULL_PATH
            
            # Diagnostic 2: Tente de lister le contenu du JAR (Confirme s'il s'agit d'une archive valide)
            jar -tf $JAR_FULL_PATH || echo "ERREUR DE DIAGNOSTIC: Le JAR n'est PAS une archive ZIP/JAR valide."
            
            # Diagnostic 3: Tente d'exÃ©cuter le JAR avec la classe loader
            echo "Tentative de diagnostic via la classe loader..."
            /usr/bin/java -cp $JAR_FULL_PATH org.springframework.boot.loader.JarLauncher || echo "Diagnostic: JarLauncher a Ã©chouÃ©. Le JAR est probablement mal construit ou il y a un problÃ¨me de classpath."
            
            echo "--- Fin du diagnostic. DÃ©ploiement Systemd ---"
            
            # 1. Stopper l'application avant de recharger le service (sÃ©curitÃ©)
            systemctl stop $SERVICE_NAME.service || true
            
            # 2. CrÃ©er ou mettre Ã  jour le fichier de service systemd 
            cat << EOF > /etc/systemd/system/$SERVICE_NAME.service
            [Unit]
            Description=JHipster Spring Boot Application
            After=syslog.target network.target
            
            [Service]
            # Utilise le nom statique app.jar
            ExecStart=/usr/bin/java -jar $DEPLOY_PATH/$STATIC_JAR_NAME
            Restart=always
            User=root
            
            # Variables d'environnement pour l'application Spring Boot
            Environment="SPRING_PROFILES_ACTIVE=prod"
            
            # VARIABLES DE BASE DE DONNÃ‰ES (Supabase Pooler)
            Environment="JHIPSTER_DATABASE_HOST=aws-1-eu-central-2.pooler.supabase.com"
            Environment="JHIPSTER_DATABASE_PORT=5432"
            Environment="JHIPSTER_DATABASE_USER=postgres.seqwrlkotxmwgjjwkejl" 
            Environment="JHIPSTER_DATABASE_PASSWORD=${{ secrets.SUPABASE_PASSWORD }}"
            
            # SECRETS DE L'APPLICATION
            Environment="STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}"
            Environment="JHIPSTER_SECURITY_AUTHENTICATION_JWT_BASE64_SECRET=${{ secrets.JWT_SECRET }}"
            
            # ðŸ”‘ CORRECTION : AJOUT DES SECRETS CLOUDINARY
            Environment="CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}"
            Environment="CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}"
            Environment="CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}"

            [Install]
            WantedBy=multi-user.target
            EOF
            
            # 3. Recharger la configuration systemd et dÃ©marrer/redÃ©marrer le service
            systemctl daemon-reload
            systemctl enable $SERVICE_NAME.service || true 
            systemctl start $SERVICE_NAME.service 
            
            echo "--- DÃ©ploiement TerminÃ©. Affichage du statut et des logs : ---"
            systemctl status $SERVICE_NAME.service
            journalctl -u $SERVICE_NAME.service --no-pager -n 30
