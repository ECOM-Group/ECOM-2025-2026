name: JHipster CI/CD

on:
  push:
    branches: ["deploy_gasdev"]
  pull_request:
    branches: ["deploy_gasdev"]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Dummy Lint Step
        run: echo "Linting step placeholder: Replace with actual linting commands."

  build:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "maven"

      - name: Build with Maven
        run: ./mvnw -ntp verify -Pprod -DskipTests

      - name: Upload application artifact (JAR)
        uses: actions/upload-artifact@v4
        with:
          name: jhipster-app
          path: target/*.jar
          retention-days: 7

  test-unit:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Dummy Unit Test Step
        run: echo "Unit testing step placeholder"

  test-e2e:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Dummy E2E Test Step
        run: echo "E2E testing step placeholder"

  deploy-vps:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download application artifact (JAR)
        uses: actions/download-artifact@v4
        with:
          name: jhipster-app
          path: target/

      - name: Prerequisites Check and JDK Install
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: bababooeys.gasdev.fr
          username: root
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: 2222
          script: |
            apt update
            apt install -y default-jdk file

      - name: Get JAR file name
        id: get_jar
        run: |
          echo "JAR_NAME=$(ls target/*.jar | xargs basename)" >> "$GITHUB_OUTPUT"

      - name: Start SSH Agent and Add Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: Transfer JAR via SCP Command
        env:
          JAR_FILE: target/${{ steps.get_jar.outputs.JAR_NAME }}
        run: |
          SSH_OPTS="-o StrictHostKeyChecking=no"
          ssh $SSH_OPTS -p 2222 root@bababooeys.gasdev.fr "mkdir -p /opt/jhipster-app"
          scp $SSH_OPTS -P 2222 "$JAR_FILE" root@bababooeys.gasdev.fr:/opt/jhipster-app/app.jar

      - name: Deploy and Start via SSH (Systemd)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: bababooeys.gasdev.fr
          username: root
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: 2222
          script: |
            SERVICE_NAME="jhipster-app"
            DEPLOY_PATH="/opt/jhipster-app"
            JAR_FULL_PATH="$DEPLOY_PATH/app.jar"

            echo "--- Diagnostic JAR ---"
            ls -lh "$JAR_FULL_PATH"
            file "$JAR_FULL_PATH"
            jar -tf "$JAR_FULL_PATH" || echo "JAR invalide"
            java -cp "$JAR_FULL_PATH" org.springframework.boot.loader.JarLauncher || echo "JarLauncher KO"

            echo "--- Ã‰criture du fichier systemd ---"

            cat << 'EOF' > /etc/systemd/system/jhipster-app.service
[Unit]
Description=JHipster Spring Boot Application
After=syslog.target network.target

[Service]
ExecStart=/usr/bin/java -jar /opt/jhipster-app/app.jar
Restart=always
User=root

Environment="SPRING_PROFILES_ACTIVE=prod"
Environment="JHIPSTER_DATABASE_HOST=aws-1-eu-central-2.pooler.supabase.com"
Environment="JHIPSTER_DATABASE_PORT=5432"
Environment="JHIPSTER_DATABASE_USER=postgres.seqwrlkotxmwgjjwkejl"
Environment="JHIPSTER_DATABASE_PASSWORD=${SUPABASE_PASSWORD}"

Environment="STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}"
Environment="JHIPSTER_SECURITY_AUTHENTICATION_JWT_BASE64_SECRET=${JWT_SECRET}"

Environment="CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}"
Environment="CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}"
Environment="CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}"

[Install]
WantedBy=multi-user.target
EOF

            echo "--- Reload systemd ---"
            systemctl daemon-reload
            systemctl enable jhipster-app.service || true
            systemctl restart jhipster-app.service

            systemctl status jhipster-app.service
            journalctl -u jhipster-app.service --no-pager -n 30
